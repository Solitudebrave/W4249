x.train <- c(11.70, 12.70, 13.75, 13.25, 14.30, 15.30, 11.40, 12.40, 12.95, 13.10, 14.10, 15.10, 11.70, 15.30, 16.20, 17.15, 13.30, 15.30, 12.30, 13.30, 14.30, 23.90, 16.10, 18.30, 11.85, 13.05, 14.05, 11.15, 12.10, 13.10, 10.25, 11.20, 11.40, 12.50, 13.50, 15.70, 16.70, 17.75, 17.65, 18.65, 19.70, 10.60, 11.70, 14.00, 10.15, 11.10, 12.10, 14.90, 15.95, 17.15, 10.65, 11.65, 12.60, 16.00, 17.00, 18.00, 13.90, 14.95, 15.90, 12.70, 13.75,  9.80, 10.85, 11.90, 16.40, 17.55, 18.75, 20.65, 22.00, 13.15, 14.10, 15.25, 14.05, 15.05, 11.15, 12.10, 13.15, 11.95, 13.25, 14.35, 19.80, 18.65, 19.60, 20.80, 21.85, 17.90, 19.05, 20.05, 15.20, 16.25, 17.40, 12.15, 13.40, 14.60, 10.25, 11.55, 12.70, 17.65, 18.70, 22.00, 23.05, 24.10, 16.05, 17.65, 22.90, 24.10, 25.20, 10.10, 13.00, 17.40, 17.15, 18.25, 19.35, 19.40, 20.70, 10.15, 18.75, 11.55, 12.60, 13.65, 18.35,  19.40, 16.95, 18.10, 19.35, 20.85, 25.20, 19.15, 20.55, 21.85, 20.90, 22.00, 13.90, 14.90, 15.90, 24.70, 20.15, 21.25, 23.70, 24.70, 16.70, 10.75, 11.90, 13.05, 14.15, 15.35, 16.45, 22.55, 17.95, 19.25, 20.35, 15.20, 16.20, 25.15, 14.00, 15.15, 11.65, 12.70, 18.10, 20.40, 13.45, 11.95, 14.70,  9.95, 11.50, 12.30, 13.35, 10.75, 11.75, 10.50, 11.80, 23.30, 12.50, 21.60, 20.75, 22.00, 14.95, 16.10, 20.60, 21.70, 20.40, 19.90, 20.95, 18.70, 19.25, 20.30, 16.55, 16.30, 19.90, 18.65, 20.40, 19.85, 14.95, 19.30, 15.60, 12.75, 16.35, 16.50, 15.40,  9.75, 14.65, 11.60,11.90, 11.20);

y.train <- c( 0.0180806700,  0.0601092900 , 0.0058575450,  0.0102639300, 0.2105263000,  0.0408432100, -0.0296411900, -0.0064308680, 0.1944643000,  0.0189504400,  0.0743919900,  0.0572569900, -0.0060975610,  0.0593187900, 0.0142908200,  0.0425079700, 0.1373762000, -0.0143149300,  0.0671462800,  0.1438202000, 0.0667976400,  0.0206766900,  0.0378056600,  0.0241312700, 0.0334021000,  0.0756648500,  0.1556811000,  0.0400678100, 0.0589022800,  0.0290771200,  0.0019323670,  0.0086805560, 0.0453125000,  0.0672645700, 0.1607884000,  0.0416666700,  0.0172727300, -0.0324965500,  0.0574352500,  0.0682427500, 0.0124688300,  0.0148368000,  0.0320699700,  0.0485021400, 0.0597993800,  0.1186161000,  0.1119293000,  0.1029359000, 0.1359677000,  0.0414537200,  0.0253868500,  0.0186862200,  0.0661577600,  0.0541795700,  0.1013216000,  0.0613333300, -0.0247647400,  0.0221201300,  0.0900900900, -0.0121951200, -0.0032066700,  0.0654596100,  0.0308972100,  0.0960809100, -0.0028037380,  0.0194650700, -0.0049858730,  0.0216880500, -0.0097087380,  0.0458978800, -0.0148760300,  0.1045431000, 0.1773836000,  0.0615484300,  0.0472466600,  0.0914205300, 0.1710403000,  0.1711855000,  0.1303646000,  0.0423771600, -0.0183823500,  0.0111337900, -0.0050748540,  0.0366726300, 0.0164718800,  0.0145560400, -0.0204838100,  0.0170752500,  0.0835591700,  0.0488503900,  0.0230891700,  0.0270636000,  0.1173268000,  0.0778781000,  0.0769230800,  0.0656266800, 0.0811855700,  0.0074899350,  0.0071501530,  0.0346598200, -0.0315813200, -0.0089974290,  0.0673135200,  0.0760361000, -0.0031746030, -0.0207138300,  0.0009803922, 0.0496306600, 0.1005068000,  0.0533480500,  0.0036327310, -0.0235187700, 0.0222861900, -0.0040355130, -0.0050648300,  0.0403746800, -0.0174825200,  0.0444905800,  0.1399689000,  0.1500682000, -0.0035826240, -0.0158259100,  0.0139593000, -0.0103189500, 0.0064977260,  0.0119392800,  0.0016072000, -0.0221937700, 0.0232123600,  0.0050089450, -0.0049751240,  0.0173611100, 0.0435806800,  0.1015801000,  0.0286885200,  0.0312500000, -0.0096098400, -0.0330225300, -0.0153110000,  0.0029154520, 0.1067107000,  0.0427179300,  0.0432445100, -0.0269138800,  0.0416024700,  0.0978686400,  0.0274887100, -0.0020671830, 0.0076824580, -0.0121019600,  0.0499500500,  0.0775656300, 0.0600436700,  0.0258603500,  0.0099950020,  0.1090909000, 0.0012950010,  0.0440967300,  0.0218485200,  0.0072604070, 0.0869087900,  0.0543887500,  0.0587929200,  0.0160547300, 0.0353925400,  0.0221606600,  0.0197092900, 0.0441919200, 0.0161450600,  0.0118221900,  0.0420792100,  0.0172853000, 0.1613262000,  0.0073242190, -0.0364064700,  0.0157756400, 0.1236917000,  0.0934426200,  0.0274669400, -0.0338283800, -0.0312832800,  0.0353319100,  0.0159819500,  0.0259067400, 0.0283409600, -0.0441860500, 0.1060335000,  0.0357967700, 0.0119214600,  0.0484199800,  0.0202788300,  0.0217408800,  0.1496941000,  0.0251256300,  0.0244858000,  0.0190496300, 0.0095137420,  0.0632124400,  0.0362694300,  0.0217485900, 0.0496598600,  0.1163683000,  0.0289855100, -0.0641025600);

length(x.train)
my.spar<-seq(0.76,0.85,0.01)

#cross validation
set.seed(1)
ind.train<-sample(204,160)
ind.cv<-setdiff(c(1:204),ind.train)

#set the training and cv data set
x.trainset<-x.train[ind.train]
x.cv<-x.train[ind.cv]
y.trainset<-y.train[ind.train]
y.cv<-y.train[ind.cv]

my.mse<-rep(0,length(my.spar))
my.lambda<-rep(0,length(my.spar))
for (i in 1: length(my.spar)) {
  my.spline<-smooth.spline(x.trainset,y.trainset, spar=my.spar[i], keep.data=TRUE)
  my.pred<-predict(my.spline, x.cv)
  my.mse[i]<-mean((my.pred$y-y.cv)^2)
  my.lambda[i]<-my.spline$lambda
}
my.mse
my.lambda

#find the optimal lambda
plot(my.spar, my.mse, type='l', xlab='Spar', ylab='MSE', main='MSE v.s Spar')
plot(my.lambda, my.mse, type='l', xlab='Lambda', ylab='MSE', main='MSE v.s Lambda')

#fit the data with optimal lambda
spar.opt<-my.spar[which.min(my.mse)]
lambda.opt<-my.lambda[which.min(my.mse)]
my.spline<-smooth.spline(x.train,y.train, spar=spar.opt, keep.data=TRUE)
plot(x.train,y.train, xlab="x", ylab="y", main='Smooth Spline with lambda=0.016')
lines(my.spline)
